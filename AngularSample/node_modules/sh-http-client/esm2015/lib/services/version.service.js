/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { ShHttpClientConst, Response } from '../constShHttpClient';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class VersionService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        //versionのキャッシュ
        this.versions = [];
    }
    /**
     * versionの初期化
     * @param {...?} urls
     * @return {?}
     */
    initVersion(...urls) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (!urls)
                return;
            yield Promise.all(urls.map((/**
             * @param {?} url
             * @return {?}
             */
            (url) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                /** @type {?} */
                const result = yield this.fetchVersion(url);
                this.setVersionNo(url, result);
                return;
            }))));
        });
    }
    /**
     * urlからキーを生成
     * @private
     * @param {?} url
     * @return {?}
     */
    getKeyUrl(url) {
        if (!url)
            return "";
        return url.split(ShHttpClientConst.API_URL)[0] + ShHttpClientConst.VERSION_API_URL;
    }
    /**
     * バックエンドのversion情報を取得
     * @param {?} url
     * @return {?}
     */
    fetchVersion(url) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const s = this.splitByApiUrl(url);
            /** @type {?} */
            const token = sessionStorage.getItem(`${ShHttpClientConst.AUTHORIZATION_TOKEN}`);
            return this.http.get(s, { observe: Response, headers: { "Authorization": token ? ShHttpClientConst.Bearer + token : ShHttpClientConst.Bearer } }).toPromise()
                .then((/**
             * @param {?} response
             * @return {?}
             */
            response => {
                if (response.body.redirectURL == ShHttpClientConst.RELOAD) {
                    setTimeout((/**
                     * @return {?}
                     */
                    function () { location.reload(); }), 100);
                }
                else if ((response.body.redirectURL || "").indexOf(ShHttpClientConst.HTTP) != -1) {
                    setTimeout((/**
                     * @return {?}
                     */
                    function () { location.href = response.body.redirectURL; }), 100);
                }
                return response.body.applicationData ? response.body.applicationData.versionNo : "";
            }));
        });
    }
    /**
     * urlをsplitした値を返す
     * @private
     * @param {?} url
     * @return {?}
     */
    splitByApiUrl(url) {
        return url.split(ShHttpClientConst.API_URL)[0] + ShHttpClientConst.VERSION_API_URL || '';
    }
    /**
     * キャッシュしているversionをURLから取得する
     * @param {?} url
     * @return {?}
     */
    getVersion(url) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const keyUrl = this.getKeyUrl(url);
            /** @type {?} */
            const projectVersion = this.versions
                .find((/**
             * @param {?} value
             * @return {?}
             */
            value => {
                return value.keyUrl === keyUrl;
            }));
            if (!projectVersion) {
                /** @type {?} */
                const version = yield this.fetchVersion(url)
                // //キャッシュする
                ;
                // //キャッシュする
                this.setVersionNo(url, version);
                return version;
            }
            return projectVersion.version;
        });
    }
    /**
     * 受け取ったversionNoをキャッシュする
     * @param {?} url apiUrl
     * @param {?} versionNo バックエンドのversion
     * @return {?}
     */
    setVersionNo(url, versionNo) {
        /** @type {?} */
        const keyUrl = this.getKeyUrl(url);
        if (!keyUrl || !versionNo)
            return;
        /** @type {?} */
        const result = this.versions.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        item => item.keyUrl == keyUrl));
        if (result != -1) {
            this.versions[result] = { keyUrl, version: versionNo };
        }
        else {
            this.versions.push({ keyUrl, version: versionNo });
        }
    }
}
VersionService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
VersionService.ctorParameters = () => [
    { type: HttpClient }
];
/** @nocollapse */ VersionService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function VersionService_Factory() { return new VersionService(i0.ɵɵinject(i1.HttpClient)); }, token: VersionService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    VersionService.prototype.versions;
    /**
     * @type {?}
     * @private
     */
    VersionService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVyc2lvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vc2gtaHR0cC1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdmVyc2lvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7QUFVbkUsTUFBTSxPQUFPLGNBQWM7Ozs7SUFLekIsWUFDVSxJQUFnQjtRQUFoQixTQUFJLEdBQUosSUFBSSxDQUFZOztRQUhsQixhQUFRLEdBQTBDLEVBQUUsQ0FBQztJQUl6RCxDQUFDOzs7Ozs7SUFLUSxXQUFXLENBQUMsR0FBRyxJQUFjOztZQUN4QyxJQUFJLENBQUMsSUFBSTtnQkFBRSxPQUFPO1lBQ2xCLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRzs7OztZQUFDLENBQU8sR0FBRyxFQUFFLEVBQUU7O3NCQUNqQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQztnQkFDM0MsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUE7Z0JBQzlCLE9BQU07WUFDUixDQUFDLENBQUEsRUFBQyxDQUFDLENBQUE7UUFDTCxDQUFDO0tBQUE7Ozs7Ozs7SUFNTyxTQUFTLENBQUMsR0FBVztRQUMzQixJQUFJLENBQUMsR0FBRztZQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ3BCLE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxlQUFlLENBQUM7SUFDckYsQ0FBQzs7Ozs7O0lBSVksWUFBWSxDQUFDLEdBQVc7OztrQkFD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RDthQUFLO1lBQ0osSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7U0FDcEQ7SUFDSCxDQUFDOzs7WUEzRkYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7O1lBVlEsVUFBVTs7Ozs7Ozs7SUFjakIsa0NBQTZEOzs7OztJQUczRCw4QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IFNoSHR0cENsaWVudENvbnN0LCBSZXNwb25zZSB9IGZyb20gJy4uL2NvbnN0U2hIdHRwQ2xpZW50JztcclxuaW1wb3J0IHsgU2hIdHRwQ2xpZW50U2VydmljZSB9IGZyb20gJy4vc2gtaHR0cC1jbGllbnQuc2VydmljZSc7XHJcbmltcG9ydCB7IEFwaVJlc3BvbnNlQm9keSB9IGZyb20gJy4uL3V0aWxpdGllcy9BcGlSZXNwb25zZUJvZHknO1xyXG5pbXBvcnQgeyBhc3luYyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XHJcbmltcG9ydCB7IEFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vdXRpbGl0aWVzL0FwaVJlc3BvbnNlJztcclxuXHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBWZXJzaW9uU2VydmljZSB7XHJcblxyXG4gIC8vdmVyc2lvbuOBruOCreODo+ODg+OCt+ODpVxyXG4gIHByaXZhdGUgdmVyc2lvbnM6IHsga2V5VXJsOiBzdHJpbmcsIHZlcnNpb246IHN0cmluZyB9W10gPSBbXTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnRcclxuICApIHsgfVxyXG5cclxuICAvKipcclxuICAgKiB2ZXJzaW9u44Gu5Yid5pyf5YyWXHJcbiAgICovXHJcbiAgcHVibGljIGFzeW5jIGluaXRWZXJzaW9uKC4uLnVybHM6IHN0cmluZ1tdKSB7XHJcbiAgICBpZiAoIXVybHMpIHJldHVybjtcclxuICAgIGF3YWl0IFByb21pc2UuYWxsKHVybHMubWFwKGFzeW5jICh1cmwpID0+IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5mZXRjaFZlcnNpb24odXJsKVxyXG4gICAgICB0aGlzLnNldFZlcnNpb25Obyh1cmwsIHJlc3VsdClcclxuICAgICAgcmV0dXJuXHJcbiAgICB9KSlcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHVybOOBi+OCieOCreODvOOCkueUn+aIkFxyXG4gICAqIEBwYXJhbSB1cmwgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRLZXlVcmwodXJsOiBzdHJpbmcpIHtcclxuICAgIGlmICghdXJsKSByZXR1cm4gXCJcIjtcclxuICAgIHJldHVybiB1cmwuc3BsaXQoU2hIdHRwQ2xpZW50Q29uc3QuQVBJX1VSTClbMF0gKyBTaEh0dHBDbGllbnRDb25zdC5WRVJTSU9OX0FQSV9VUkw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOODkOODg+OCr+OCqOODs+ODieOBrnZlcnNpb27mg4XloLHjgpLlj5blvpdcclxuICAgKi9cclxuICBwdWJsaWMgYXN5bmMgZmV0Y2hWZXJzaW9uKHVybDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIGNvbnN0IHMgPSB0aGlzLnNwbGl0QnlBcGlVcmwodXJsKTtcclxuICAgIGNvbnN0IHRva2VuID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShgJHtTaEh0dHBDbGllbnRDb25zdC5BVVRIT1JJWkFUSU9OX1RPS0VOfWApXHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldDxBcGlSZXNwb25zZUJvZHk8YW55Pj4ocywgeyBvYnNlcnZlOiBSZXNwb25zZSwgaGVhZGVyczogeyBcIkF1dGhvcml6YXRpb25cIjogdG9rZW4gPyBTaEh0dHBDbGllbnRDb25zdC5CZWFyZXIgKyB0b2tlbiA6IFNoSHR0cENsaWVudENvbnN0LkJlYXJlciB9IH0pLnRvUHJvbWlzZSgpXHJcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcclxuICAgICAgICBpZiAocmVzcG9uc2UuYm9keS5yZWRpcmVjdFVSTCA9PSBTaEh0dHBDbGllbnRDb25zdC5SRUxPQUQpIHtcclxuICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtsb2NhdGlvbi5yZWxvYWQoKTt9LCAxMDApO1xyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoKHJlc3BvbnNlLmJvZHkucmVkaXJlY3RVUkwgfHwgXCJcIikuaW5kZXhPZihTaEh0dHBDbGllbnRDb25zdC5IVFRQKSAhPSAtMSkge1xyXG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe2xvY2F0aW9uLmhyZWYgPSByZXNwb25zZS5ib2R5LnJlZGlyZWN0VVJMO30sIDEwMCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXNwb25zZS5ib2R5LmFwcGxpY2F0aW9uRGF0YSA/IHJlc3BvbnNlLmJvZHkuYXBwbGljYXRpb25EYXRhLnZlcnNpb25ObyA6IFwiXCI7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogdXJs44KSc3BsaXTjgZfjgZ/lgKTjgpLov5TjgZlcclxuICAgKi9cclxuICBwcml2YXRlIHNwbGl0QnlBcGlVcmwodXJsOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB1cmwuc3BsaXQoU2hIdHRwQ2xpZW50Q29uc3QuQVBJX1VSTClbMF0gKyBTaEh0dHBDbGllbnRDb25zdC5WRVJTSU9OX0FQSV9VUkwgfHwgJyc7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOOCreODo+ODg+OCt+ODpeOBl+OBpuOBhOOCi3ZlcnNpb27jgpJVUkzjgYvjgonlj5blvpfjgZnjgotcclxuICAgKiBAcGFyYW0gdXJsXHJcbiAgICovXHJcbiAgcHVibGljIGFzeW5jIGdldFZlcnNpb24odXJsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgY29uc3Qga2V5VXJsID0gdGhpcy5nZXRLZXlVcmwodXJsKVxyXG4gICAgY29uc3QgcHJvamVjdFZlcnNpb24gPSB0aGlzLnZlcnNpb25zXHJcbiAgICAgIC5maW5kKHZhbHVlID0+IHtcclxuICAgICAgICByZXR1cm4gdmFsdWUua2V5VXJsID09PSBrZXlVcmxcclxuICAgICAgfSlcclxuICAgIGlmICghcHJvamVjdFZlcnNpb24pIHtcclxuICAgICAgY29uc3QgdmVyc2lvbiA9IGF3YWl0IHRoaXMuZmV0Y2hWZXJzaW9uKHVybClcclxuICAgICAgLy8gLy/jgq3jg6Pjg4Pjgrfjg6XjgZnjgotcclxuICAgICAgdGhpcy5zZXRWZXJzaW9uTm8odXJsLCB2ZXJzaW9uKVxyXG4gICAgICByZXR1cm4gdmVyc2lvbjtcclxuICAgIH1cclxuICAgIHJldHVybiBwcm9qZWN0VmVyc2lvbi52ZXJzaW9uO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPl+OBkeWPluOBo+OBn3ZlcnNpb25Ob+OCkuOCreODo+ODg+OCt+ODpeOBmeOCi1xyXG4gICAqIEBwYXJhbSB1cmwgYXBpVXJsXHJcbiAgICogQHBhcmFtIHZlcnNpb25ObyDjg5Djg4Pjgq/jgqjjg7Pjg4njga52ZXJzaW9uIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRWZXJzaW9uTm8odXJsOiBzdHJpbmcsIHZlcnNpb25Obzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBrZXlVcmwgPSB0aGlzLmdldEtleVVybCh1cmwpO1xyXG4gICAgaWYgKCFrZXlVcmwgfHwgIXZlcnNpb25ObykgcmV0dXJuXHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnZlcnNpb25zLmZpbmRJbmRleChpdGVtID0+IGl0ZW0ua2V5VXJsID09IGtleVVybCk7XHJcbiAgICBpZihyZXN1bHQgIT0gLTEpIHtcclxuICAgICAgdGhpcy52ZXJzaW9uc1tyZXN1bHRdID0geyBrZXlVcmwsIHZlcnNpb246IHZlcnNpb25ObyB9O1xyXG4gICAgfWVsc2Uge1xyXG4gICAgICB0aGlzLnZlcnNpb25zLnB1c2goeyBrZXlVcmwsIHZlcnNpb246IHZlcnNpb25ObyB9KTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19