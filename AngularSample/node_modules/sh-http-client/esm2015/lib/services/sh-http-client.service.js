/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { catchError, map } from 'rxjs/operators';
import { VersionService } from './version.service';
import { AlertHandlerService } from './alert-handler.service';
import { ValidationErrorService } from './validation-error.service';
import { ApiResponseBody } from '../utilities/ApiResponseBody';
import { ShHttpClientConst, Response } from '../constShHttpClient';
import { SHMessage } from '../utilities/ShMessage';
import { ShRedirectService } from './sh-redirect.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./version.service";
import * as i3 from "./alert-handler.service";
import * as i4 from "./validation-error.service";
import * as i5 from "./sh-redirect.service";
export class ShHttpClientService {
    /**
     * @param {?} http
     * @param {?} versionService
     * @param {?} alertHandlerService
     * @param {?} validationErrorService
     * @param {?} redirectService
     */
    constructor(http, versionService, alertHandlerService, validationErrorService, redirectService) {
        this.http = http;
        this.versionService = versionService;
        this.alertHandlerService = alertHandlerService;
        this.validationErrorService = validationErrorService;
        this.redirectService = redirectService;
    }
    /**
     * AccessTokenの有無を返す
     * @return {?}
     */
    get hasToken() {
        return !!sessionStorage.getItem('AccessToken');
    }
    /**
     * httpOptionを返す
     * @private
     * @param {?} versionNo
     * @return {?}
     */
    getOption(versionNo) {
        /** @type {?} */
        const token = sessionStorage.getItem(`${ShHttpClientConst.AUTHORIZATION_TOKEN}`);
        /** @type {?} */
        let headers = new HttpHeaders({ "Version-No": versionNo });
        headers = headers.set('Content-Type', 'application/json; charset=utf-8');
        /** @type {?} */
        const accessToken = token ? ShHttpClientConst.Bearer + token : ShHttpClientConst.Bearer;
        headers = headers.set('Authorization', accessToken);
        return { observe: Response, headers };
    }
    /**
     * GET
     * @private
     * @template T
     * @param {?} apiResponseBody レスポンスBody情報
     * @param {?} showValidationResult
     * @return {?} レスポンスBody内のbody句
     */
    getApiResponseBody(apiResponseBody, showValidationResult) {
        if (apiResponseBody.status != ShHttpClientConst.STATUS_OK)
            return new ApiResponseBody();
        if (apiResponseBody.body) {
            if (apiResponseBody.body.message) {
                alert(apiResponseBody.body.message);
            }
            if (apiResponseBody.body.message) {
                alert(apiResponseBody.body.message);
            }
            if (apiResponseBody.body.redirectURL == ShHttpClientConst.RELOAD) {
                setTimeout((/**
                 * @return {?}
                 */
                function () { location.reload(); }), 100);
            }
            else if ((apiResponseBody.body.redirectURL || "").indexOf(ShHttpClientConst.HTTP) != -1) {
                // useHashがtrueになっていることが前提条件です
                this.redirectService.setRedirectPath();
                setTimeout((/**
                 * @return {?}
                 */
                function () { location.href = apiResponseBody.body.redirectURL; }), 100);
            }
            if (showValidationResult) {
                //バリデーション処理
                if (apiResponseBody.body.hasValidationErrors) {
                    this.validationErrorService.setValidationError(apiResponseBody.body.validationErrors);
                }
                else {
                    this.validationErrorService.clearValidationError();
                }
            }
            if (apiResponseBody.body.alert) {
                //アラート処理
                this.alertHandlerService.setAlert(apiResponseBody.body.alert);
            }
        }
        return apiResponseBody.body;
    }
    /**
     * 認証済みかどうか
     * @private
     * @return {?}
     */
    isAuthenticate() {
        return !!sessionStorage.getItem(`${ShHttpClientConst.AUTHORIZATION_TOKEN}`);
    }
    /**
     * GET
     * @template T
     * @param {?} url ApiUrl
     * @param {?=} showValidationResult
     * @return {?} API返却結果
     */
    get(url, showValidationResult = true) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            let versionNo = "";
            if (this.isAuthenticate()) {
                versionNo = yield this.versionService.getVersion(url);
            }
            /** @type {?} */
            const option = this.getOption(versionNo);
            return this.http.get(this.encodeUrl(url), option).pipe(map((/**
             * @param {?} response
             * @return {?}
             */
            response => {
                return this.getApiResponseBody(response, showValidationResult);
            })), catchError(this.handleError("get error"))).toPromise();
        });
    }
    /**
     * POST
     * @template T
     * @param {?} url ApiUrl
     * @param {?} data データ
     * @param {?=} showValidationResult
     * @return {?} API返却結果
     */
    post(url, data, showValidationResult = true) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const versionNo = yield this.versionService.getVersion(url);
            /** @type {?} */
            const option = this.getOption(versionNo);
            return this.http.post(url, data, option).pipe(map((/**
             * @param {?} response
             * @return {?}
             */
            response => {
                return this.getApiResponseBody(response, showValidationResult);
            })), catchError(this.handleError("post error"))).toPromise();
        });
    }
    /**
     * PUT
     * @template T
     * @param {?} url ApiUrl
     * @param {?} data データ
     * @param {?=} showValidationResult
     * @return {?} API返却結果
     */
    put(url, data, showValidationResult = true) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const versionNo = yield this.versionService.getVersion(url);
            /** @type {?} */
            const option = this.getOption(versionNo);
            return this.http.put(url, data, option).pipe(map((/**
             * @param {?} response
             * @return {?}
             */
            response => {
                return this.getApiResponseBody(response, showValidationResult);
            })), catchError(this.handleError("put error"))).toPromise();
        });
    }
    /**
     * DELETE
     * @template T
     * @param {?} url ApiUrl
     * @param {?=} showValidationResult
     * @return {?} API返却結果
     */
    delete(url, showValidationResult = true) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const versionNo = yield this.versionService.getVersion(url);
            /** @type {?} */
            const option = this.getOption(versionNo);
            return this.http.delete(url, option).pipe(map((/**
             * @param {?} response
             * @return {?}
             */
            response => {
                return this.getApiResponseBody(response, showValidationResult);
            })), catchError(this.handleError("delete error"))).toPromise();
        });
    }
    /**
     * エラーハンドラ
     * @private
     * @template T
     * @param {?=} operation どの処理でエラーが起きたか
     * @param {?=} result 空の配列か指定無しを返して処理を継続させる
     * @return {?}
     */
    handleError(operation = 'operation', result) {
        return (/**
         * @param {?} error
         * @return {?}
         */
        (error) => {
            /** @type {?} */
            const msg = new SHMessage();
            alert(msg.fatal.systemErrorHasOccurred());
            throw error;
        });
    }
    /**
     * urlをエンコードする。インターステージ用の対応
     * @private
     * @param {?} url
     * @return {?}
     */
    encodeUrl(url) {
        if (!url)
            return;
        if (url.indexOf('?')) {
            return encodeURI(url);
        }
        return url;
    }
}
ShHttpClientService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ShHttpClientService.ctorParameters = () => [
    { type: HttpClient },
    { type: VersionService },
    { type: AlertHandlerService },
    { type: ValidationErrorService },
    { type: ShRedirectService }
];
/** @nocollapse */ ShHttpClientService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function ShHttpClientService_Factory() { return new ShHttpClientService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.VersionService), i0.ɵɵinject(i3.AlertHandlerService), i0.ɵɵinject(i4.ValidationErrorService), i0.ɵɵinject(i5.ShRedirectService)); }, token: ShHttpClientService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    ShHttpClientService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ShHttpClientService.prototype.versionService;
    /**
     * @type {?}
     * @private
     */
    ShHttpClientService.prototype.alertHandlerService;
    /**
     * @type {?}
     * @private
     */
    ShHttpClientService.prototype.validationErrorService;
    /**
     * @type {?}
     * @private
     */
    ShHttpClientService.prototype.redirectService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2gtaHR0cC1jbGllbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3NoLWh0dHAtY2xpZW50LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3NoLWh0dHAtY2xpZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDOUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUVoRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxRQUFRLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7Ozs7QUFLMUQsTUFBTSxPQUFPLG1CQUFtQjs7Ozs7Ozs7SUFFOUIsWUFDVSxJQUFnQixFQUNoQixjQUE4QixFQUM5QixtQkFBd0MsRUFDeEMsc0JBQThDLEVBQzlDLGVBQWtDO1FBSmxDLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUM5QyxvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7SUFDeEMsQ0FBQzs7Ozs7SUFLTCxJ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LGNBQWMsQ0FBQyxDQUFDLENBQ2xELENBQUMsU0FBUyxFQUFFLENBQUM7UUFFaEIsQ0FBQztLQUFBOzs7Ozs7Ozs7SUFPTyxXQUFXLENBQUksU0FBUyxHQUFHLFdBQVcsRUFBRSxNQUFVO1FBQ3hEOzs7O1FBQU8sQ0FBQyxLQUFVLEVBQWlCLEVBQUU7O2tCQUM3QixHQUFHLEdBQWMsSUFBSSxTQUFTLEVBQUU7WUFDdEMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQyxFQUFDO0lBRUosQ0FBQzs7Ozs7OztJQUtPLFNBQVMsQ0FBQyxHQUFXO1FBQzNCLElBQUksQ0FBQyxHQUFHO1lBQUUsT0FBTztRQUNqQixJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDcEIsT0FBTyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdkI7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7OztZQTVLRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUFiUSxVQUFVO1lBR1YsY0FBYztZQUNkLG1CQUFtQjtZQUNuQixzQkFBc0I7WUFJdEIsaUJBQWlCOzs7Ozs7OztJQVF0QixtQ0FBd0I7Ozs7O0lBQ3hCLDZDQUFzQzs7Ozs7SUFDdEMsa0RBQWdEOzs7OztJQUNoRCxxREFBc0Q7Ozs7O0lBQ3RELDhDQUEwQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnXHJcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnXHJcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJ1xyXG5pbXBvcnQgeyBBcGlSZXNwb25zZSB9IGZyb20gJy4uL3V0aWxpdGllcy9BcGlSZXNwb25zZSc7XHJcbmltcG9ydCB7IFZlcnNpb25TZXJ2aWNlIH0gZnJvbSAnLi92ZXJzaW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBbGVydEhhbmRsZXJTZXJ2aWNlIH0gZnJvbSAnLi9hbGVydC1oYW5kbGVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3JTZXJ2aWNlIH0gZnJvbSAnLi92YWxpZGF0aW9uLWVycm9yLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBcGlSZXNwb25zZUJvZHkgfSBmcm9tICcuLi91dGlsaXRpZXMvQXBpUmVzcG9uc2VCb2R5JztcclxuaW1wb3J0IHsgU2hIdHRwQ2xpZW50Q29uc3QsIFJlc3BvbnNlIH0gZnJvbSAnLi4vY29uc3RTaEh0dHBDbGllbnQnO1xyXG5pbXBvcnQgeyBTSE1lc3NhZ2UgfSBmcm9tICcuLi91dGlsaXRpZXMvU2hNZXNzYWdlJztcclxuaW1wb3J0IHsgU2hSZWRpcmVjdFNlcnZpY2UgfSBmcm9tICcuL3NoLXJlZGlyZWN0LnNlcnZpY2UnO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgU2hIdHRwQ2xpZW50U2VydmljZSB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxyXG4gICAgcHJpdmF0ZSB2ZXJzaW9uU2VydmljZTogVmVyc2lvblNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGFsZXJ0SGFuZGxlclNlcnZpY2U6IEFsZXJ0SGFuZGxlclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHZhbGlkYXRpb25FcnJvclNlcnZpY2U6IFZhbGlkYXRpb25FcnJvclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHJlZGlyZWN0U2VydmljZTogU2hSZWRpcmVjdFNlcnZpY2VcclxuICApIHsgfVxyXG5cclxuICAvKipcclxuICAgKiBBY2Nlc3NUb2tlbuOBruacieeEoeOCkui/lOOBmVxyXG4gICAqL1xyXG4gIGdldCBoYXNUb2tlbigpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhIXNlc3Npb25TdG9yYWdlLmdldEl0ZW0oJ0FjY2Vzc1Rva2VuJyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIGh0dHBPcHRpb27jgpLov5TjgZlcclxuICAgKiBAcGFyYW0gdmVyc2lvbk5vIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0T3B0aW9uKHZlcnNpb25Obzogc3RyaW5nKTogb2JqZWN0IHtcclxuICAgIGNvbnN0IHRva2VuID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShgJHtTaEh0dHBDbGllbnRDb25zdC5BVVRIT1JJWkFUSU9OX1RPS0VOfWApXHJcbiAgICBsZXQgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7IFwiVmVyc2lvbi1Ob1wiOiB2ZXJzaW9uTm8gfSlcclxuICAgIGhlYWRlcnMgPSBoZWFkZXJzLnNldCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnKTtcclxuICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gdG9rZW4gPyBTaEh0dHBDbGllbnRDb25zdC5CZWFyZXIgKyB0b2tlbiA6IFNoSHR0cENsaWVudENvbnN0LkJlYXJlcjtcclxuICAgIGhlYWRlcnMgPSBoZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsIGFjY2Vzc1Rva2VuKTtcclxuICAgIHJldHVybiB7IG9ic2VydmU6IFJlc3BvbnNlLCBoZWFkZXJzIH07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICogR0VUXHJcbiAgKiBAcGFyYW0gYXBpUmVzcG9uc2VCb2R5IOODrOOCueODneODs+OCuUJvZHnmg4XloLFcclxuICAqIEByZXR1cm4g44Os44K544Od44Oz44K5Qm9keeWGheOBrmJvZHnlj6VcclxuICAqL1xyXG4gIHByaXZhdGUgZ2V0QXBpUmVzcG9uc2VCb2R5PFQ+KGFwaVJlc3BvbnNlQm9keTogQXBpUmVzcG9uc2U8VD4sIHNob3dWYWxpZGF0aW9uUmVzdWx0OiBib29sZWFuKTogQXBpUmVzcG9uc2VCb2R5PFQ+IHtcclxuICAgIGlmIChhcGlSZXNwb25zZUJvZHkuc3RhdHVzICE9IFNoSHR0cENsaWVudENvbnN0LlNUQVRVU19PSylcclxuICAgICAgcmV0dXJuIG5ldyBBcGlSZXNwb25zZUJvZHk8VD4oKTtcclxuICAgIGlmIChhcGlSZXNwb25zZUJvZHkuYm9keSkge1xyXG4gICAgICBpZiAoYXBpUmVzcG9uc2VCb2R5LmJvZHkubWVzc2FnZSkge1xyXG4gICAgICAgIGFsZXJ0KGFwaVJlc3BvbnNlQm9keS5ib2R5Lm1lc3NhZ2UpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChhcGlSZXNwb25zZUJvZHkuYm9keS5tZXNzYWdlKSB7XHJcbiAgICAgICAgYWxlcnQoYXBpUmVzcG9uc2VCb2R5LmJvZHkubWVzc2FnZSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGFwaVJlc3BvbnNlQm9keS5ib2R5LnJlZGlyZWN0VVJMID09IFNoSHR0cENsaWVudENvbnN0LlJFTE9BRCkge1xyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtsb2NhdGlvbi5yZWxvYWQoKTt9LCAxMDApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKChhcGlSZXNwb25zZUJvZHkuYm9keS5yZWRpcmVjdFVSTCB8fCBcIlwiKS5pbmRleE9mKFNoSHR0cENsaWVudENvbnN0LkhUVFApICE9IC0xKSB7XHJcbiAgICAgICAgLy8gdXNlSGFzaOOBjHRydWXjgavjgarjgaPjgabjgYTjgovjgZPjgajjgYzliY3mj5DmnaHku7bjgafjgZlcclxuICAgICAgICB0aGlzLnJlZGlyZWN0U2VydmljZS5zZXRSZWRpcmVjdFBhdGgoKTtcclxuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7bG9jYXRpb24uaHJlZiA9IGFwaVJlc3BvbnNlQm9keS5ib2R5LnJlZGlyZWN0VVJMfSwgMTAwKTtcclxuICAgICAgfVxyXG4gICAgICBpZihzaG93VmFsaWRhdGlvblJlc3VsdCkge1xyXG4gICAgICAgIC8v44OQ44Oq44OH44O844K344On44Oz5Yem55CGXHJcbiAgICAgICAgaWYgKGFwaVJlc3BvbnNlQm9keS5ib2R5Lmhhc1ZhbGlkYXRpb25FcnJvcnMpIHtcclxuICAgICAgICAgIHRoaXMudmFsaWRhdGlvbkVycm9yU2VydmljZS5zZXRWYWxpZGF0aW9uRXJyb3IoYXBpUmVzcG9uc2VCb2R5LmJvZHkudmFsaWRhdGlvbkVycm9ycyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMudmFsaWRhdGlvbkVycm9yU2VydmljZS5jbGVhclZhbGlkYXRpb25FcnJvcigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgaWYgKGFwaVJlc3BvbnNlQm9keS5ib2R5LmFsZXJ0KSB7XHJcbiAgICAgICAgLy/jgqLjg6njg7zjg4jlh6bnkIZcclxuICAgICAgICB0aGlzLmFsZXJ0SGFuZGxlclNlcnZpY2Uuc2V0QWxlcnQoYXBpUmVzcG9uc2VCb2R5LmJvZHkuYWxlcnQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlQm9keS5ib2R5O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDoqo3oqLzmuIjjgb/jgYvjganjgYbjgYtcclxuICAgKi9cclxuICBwcml2YXRlIGlzQXV0aGVudGljYXRlKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICEhc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShgJHtTaEh0dHBDbGllbnRDb25zdC5BVVRIT1JJWkFUSU9OX1RPS0VOfWApXHJcbiAgfVxyXG4gIC8qKlxyXG4gICogR0VUXHJcbiAgKiBAcGFyYW0gdXJsIEFwaVVybFxyXG4gICogQHJldHVybiBBUEnov5TljbTntZDmnpxcclxuICAqL1xyXG4gIHB1YmxpYyBhc3luYyBnZXQ8VD4odXJsOiBzdHJpbmcsIHNob3dWYWxpZGF0aW9uUmVzdWx0OiBib29sZWFuID0gdHJ1ZSk6IFByb21pc2U8QXBpUmVzcG9uc2VCb2R5PFQ+PiB7XHJcbiAgICBsZXQgdmVyc2lvbk5vID0gXCJcIlxyXG4gICAgaWYgKHRoaXMuaXNBdXRoZW50aWNhdGUoKSkge1xyXG4gICAgICB2ZXJzaW9uTm8gPSBhd2FpdCB0aGlzLnZlcnNpb25TZXJ2aWNlLmdldFZlcnNpb24odXJsKTtcclxuICAgIH1cclxuICAgIGNvbnN0IG9wdGlvbjogb2JqZWN0ID0gdGhpcy5nZXRPcHRpb24odmVyc2lvbk5vKTtcclxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PEFwaVJlc3BvbnNlPFQ+Pih0aGlzLmVuY29kZVVybCh1cmwpLCBvcHRpb24pLnBpcGUoXHJcbiAgICAgIG1hcChyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QXBpUmVzcG9uc2VCb2R5PFQ+KHJlc3BvbnNlLCBzaG93VmFsaWRhdGlvblJlc3VsdCk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKHRoaXMuaGFuZGxlRXJyb3I8YW55PihcImdldCBlcnJvclwiKSlcclxuICAgICkudG9Qcm9taXNlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAqIFBPU1RcclxuICAqIEBwYXJhbSB1cmwgQXBpVXJsXHJcbiAgKiBAcGFyYW0gZGF0YSDjg4fjg7zjgr9cclxuICAqIEByZXR1cm4gQVBJ6L+U5Y2057WQ5p6cXHJcbiAgKi9cclxuICBwdWJsaWMgYXN5bmMgcG9zdDxUPih1cmw6IHN0cmluZywgZGF0YTogYW55LCBzaG93VmFsaWRhdGlvblJlc3VsdDogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFwaVJlc3BvbnNlQm9keTxUPj4ge1xyXG4gICAgY29uc3QgdmVyc2lvbk5vID0gYXdhaXQgdGhpcy52ZXJzaW9uU2VydmljZS5nZXRWZXJzaW9uKHVybCk7XHJcbiAgICBjb25zdCBvcHRpb246IG9iamVjdCA9IHRoaXMuZ2V0T3B0aW9uKHZlcnNpb25ObylcclxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxBcGlSZXNwb25zZTxUPj4odXJsLCBkYXRhLCBvcHRpb24pLnBpcGUoXHJcbiAgICAgIG1hcChyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QXBpUmVzcG9uc2VCb2R5KHJlc3BvbnNlLCBzaG93VmFsaWRhdGlvblJlc3VsdCk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKHRoaXMuaGFuZGxlRXJyb3I8YW55PihcInBvc3QgZXJyb3JcIikpXHJcbiAgICApLnRvUHJvbWlzZSgpO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICogUFVUXHJcbiAgKiBAcGFyYW0gdXJsIEFwaVVybFxyXG4gICogQHBhcmFtIGRhdGEg44OH44O844K/XHJcbiAgKiBAcmV0dXJuIEFQSei/lOWNtOe1kOaenFxyXG4gICovXHJcbiAgcHVibGljIGFzeW5jIHB1dDxUPih1cmw6IHN0cmluZywgZGF0YTogYW55LCBzaG93VmFsaWRhdGlvblJlc3VsdDogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFwaVJlc3BvbnNlQm9keTxUPj4ge1xyXG4gICAgY29uc3QgdmVyc2lvbk5vID0gYXdhaXQgdGhpcy52ZXJzaW9uU2VydmljZS5nZXRWZXJzaW9uKHVybCk7XHJcbiAgICBjb25zdCBvcHRpb246IG9iamVjdCA9IHRoaXMuZ2V0T3B0aW9uKHZlcnNpb25ObylcclxuICAgIHJldHVybiB0aGlzLmh0dHAucHV0PEFwaVJlc3BvbnNlPFQ+Pih1cmwsIGRhdGEsIG9wdGlvbikucGlwZShcclxuICAgICAgbWFwKHJlc3BvbnNlID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRBcGlSZXNwb25zZUJvZHkocmVzcG9uc2UsIHNob3dWYWxpZGF0aW9uUmVzdWx0KTtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5oYW5kbGVFcnJvcjxhbnk+KFwicHV0IGVycm9yXCIpKVxyXG4gICAgKS50b1Byb21pc2UoKTtcclxuXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAqIERFTEVURVxyXG4gICogQHBhcmFtIHVybCBBcGlVcmxcclxuICAqIEByZXR1cm4gQVBJ6L+U5Y2057WQ5p6cXHJcbiAgKi9cclxuICBwdWJsaWMgYXN5bmMgZGVsZXRlPFQ+KHVybDogc3RyaW5nLCBzaG93VmFsaWRhdGlvblJlc3VsdDogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFwaVJlc3BvbnNlQm9keTxUPj4ge1xyXG4gICAgY29uc3QgdmVyc2lvbk5vID0gYXdhaXQgdGhpcy52ZXJzaW9uU2VydmljZS5nZXRWZXJzaW9uKHVybCk7XHJcbiAgICBjb25zdCBvcHRpb246IG9iamVjdCA9IHRoaXMuZ2V0T3B0aW9uKHZlcnNpb25ObylcclxuICAgIHJldHVybiB0aGlzLmh0dHAuZGVsZXRlPEFwaVJlc3BvbnNlPFQ+Pih1cmwsIG9wdGlvbikucGlwZShcclxuICAgICAgbWFwKHJlc3BvbnNlID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRBcGlSZXNwb25zZUJvZHkocmVzcG9uc2UsIHNob3dWYWxpZGF0aW9uUmVzdWx0KTtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5oYW5kbGVFcnJvcjxhbnk+KFwiZGVsZXRlIGVycm9yXCIpKSxcclxuICAgICkudG9Qcm9taXNlKCk7XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog44Ko44Op44O844OP44Oz44OJ44OpXHJcbiAgICogQHBhcmFtIG9wZXJhdGlvbiDjganjga7lh6bnkIbjgafjgqjjg6njg7zjgYzotbfjgY3jgZ/jgYtcclxuICAgKiBAcGFyYW0gcmVzdWx0IOepuuOBrumFjeWIl+OBi+aMh+WumueEoeOBl+OCkui/lOOBl+OBpuWHpueQhuOCkue2mee2muOBleOBm+OCi1xyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFuZGxlRXJyb3I8VD4ob3BlcmF0aW9uID0gJ29wZXJhdGlvbicsIHJlc3VsdD86IFQpIHtcclxuICAgIHJldHVybiAoZXJyb3I6IGFueSk6IE9ic2VydmFibGU8VD4gPT4ge1xyXG4gICAgICBjb25zdCBtc2c6IFNITWVzc2FnZSA9IG5ldyBTSE1lc3NhZ2UoKTtcclxuICAgICAgYWxlcnQobXNnLmZhdGFsLnN5c3RlbUVycm9ySGFzT2NjdXJyZWQoKSk7XHJcbiAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfTtcclxuXHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIHVybOOCkuOCqOODs+OCs+ODvOODieOBmeOCi+OAguOCpOODs+OCv+ODvOOCueODhuODvOOCuOeUqOOBruWvvuW/nFxyXG4gICAqIEBwYXJhbSB1cmwgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBlbmNvZGVVcmwodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKCF1cmwpIHJldHVybjtcclxuICAgIGlmICh1cmwuaW5kZXhPZignPycpKSB7XHJcbiAgICAgIHJldHVybiBlbmNvZGVVUkkodXJsKTtcclxuICAgIH1cclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG59XHJcbiJdfQ==