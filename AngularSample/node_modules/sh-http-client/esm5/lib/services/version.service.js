/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { ShHttpClientConst, Response } from '../constShHttpClient';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
var VersionService = /** @class */ (function () {
    function VersionService(http) {
        this.http = http;
        //versionのキャッシュ
        this.versions = [];
    }
    /**
     * versionの初期化
     */
    /**
     * versionの初期化
     * @param {...?} urls
     * @return {?}
     */
    VersionService.prototype.initVersion = /**
     * versionの初期化
     * @param {...?} urls
     * @return {?}
     */
    function () {
        var urls = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            urls[_i] = arguments[_i];
        }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!urls)
                            return [2 /*return*/];
                        return [4 /*yield*/, Promise.all(urls.map((/**
                             * @param {?} url
                             * @return {?}
                             */
                            function (url) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                                var result;
                                return tslib_1.__generator(this, function (_a) {
                                    switch (_a.label) {
                                        case 0: return [4 /*yield*/, this.fetchVersion(url)];
                                        case 1:
                                            result = _a.sent();
                                            this.setVersionNo(url, result);
                                            return [2 /*return*/];
                                    }
                                });
                            }); })))];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * urlからキーを生成
     * @param url
     */
    /**
     * urlからキーを生成
     * @private
     * @param {?} url
     * @return {?}
     */
    VersionService.prototype.getKeyUrl = /**
     * urlからキーを生成
     * @private
     * @param {?} url
     * @return {?}
     */
    function (url) {
        if (!url)
            return "";
        return url.split(ShHttpClientConst.API_URL)[0] + ShHttpClientConst.VERSION_API_URL;
    };
    /**
     * バックエンドのversion情報を取得
     */
    /**
     * バックエンドのversion情報を取得
     * @param {?} url
     * @return {?}
     */
    VersionService.prototype.fetchVersion = /**
     * バックエンドのversion情報を取得
     * @param {?} url
     * @return {?}
     */
    function (url) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var s, token;
            return tslib_1.__generator(this, function (_a) {
                s = this.splitByApiUrl(url);
                token = sessionStorage.getItem("" + ShHttpClientConst.AUTHORIZATION_TOKEN);
                return [2 /*return*/, this.http.get(s, { observe: Response, headers: { "Authorization": token ? ShHttpClientConst.Bearer + token : ShHttpClientConst.Bearer } }).toPromise()
                        .then((/**
                     * @param {?} response
                     * @return {?}
                     */
                    function (response) {
                        if (response.body.redirectURL == ShHttpClientConst.RELOAD) {
                            setTimeout((/**
                             * @return {?}
                             */
                            function () { location.reload(); }), 100);
                        }
                        else if ((response.body.redirectURL || "").indexOf(ShHttpClientConst.HTTP) != -1) {
                            setTimeout((/**
                             * @return {?}
                             */
                            function () { location.href = response.body.redirectURL; }), 100);
                        }
                        return response.body.applicationData ? response.body.applicationData.versionNo : "";
                    }))];
            });
        });
    };
    /**
     * urlをsplitした値を返す
     */
    /**
     * urlをsplitした値を返す
     * @private
     * @param {?} url
     * @return {?}
     */
    VersionService.prototype.splitByApiUrl = /**
     * urlをsplitした値を返す
     * @private
     * @param {?} url
     * @return {?}
     */
    function (url) {
        return url.split(ShHttpClientConst.API_URL)[0] + ShHttpClientConst.VERSION_API_URL || '';
    };
    /**
     * キャッシュしているversionをURLから取得する
     * @param url
     */
    /**
     * キャッシュしているversionをURLから取得する
     * @param {?} url
     * @return {?}
     */
    VersionService.prototype.getVersion = /**
     * キャッシュしているversionをURLから取得する
     * @param {?} url
     * @return {?}
     */
    function (url) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var keyUrl, projectVersion, version;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        keyUrl = this.getKeyUrl(url);
                        projectVersion = this.versions
                            .find((/**
                         * @param {?} value
                         * @return {?}
                         */
                        function (value) {
                            return value.keyUrl === keyUrl;
                        }));
                        if (!!projectVersion) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.fetchVersion(url)
                            // //キャッシュする
                        ];
                    case 1:
                        version = _a.sent();
                        // //キャッシュする
                        this.setVersionNo(url, version);
                        return [2 /*return*/, version];
                    case 2: return [2 /*return*/, projectVersion.version];
                }
            });
        });
    };
    /**
     * 受け取ったversionNoをキャッシュする
     * @param url apiUrl
     * @param versionNo バックエンドのversion
     */
    /**
     * 受け取ったversionNoをキャッシュする
     * @param {?} url apiUrl
     * @param {?} versionNo バックエンドのversion
     * @return {?}
     */
    VersionService.prototype.setVersionNo = /**
     * 受け取ったversionNoをキャッシュする
     * @param {?} url apiUrl
     * @param {?} versionNo バックエンドのversion
     * @return {?}
     */
    function (url, versionNo) {
        /** @type {?} */
        var keyUrl = this.getKeyUrl(url);
        if (!keyUrl || !versionNo)
            return;
        /** @type {?} */
        var result = this.versions.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item.keyUrl == keyUrl; }));
        if (result != -1) {
            this.versions[result] = { keyUrl: keyUrl, version: versionNo };
        }
        else {
            this.versions.push({ keyUrl: keyUrl, version: versionNo });
        }
    };
    VersionService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    VersionService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    /** @nocollapse */ VersionService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function VersionService_Factory() { return new VersionService(i0.ɵɵinject(i1.HttpClient)); }, token: VersionService, providedIn: "root" });
    return VersionService;
}());
export { VersionService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    VersionService.prototype.versions;
    /**
     * @type {?}
     * @private
     */
    VersionService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVyc2lvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vc2gtaHR0cC1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdmVyc2lvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7QUFPbkU7SUFRRSx3QkFDVSxJQUFnQjtRQUFoQixTQUFJLEdBQUosSUFBSSxDQUFZOztRQUhsQixhQUFRLEdBQTBDLEVBQUUsQ0FBQztJQUl6RCxDQUFDO0lBRUw7O09BRUc7Ozs7OztJQUNVLG9DQUFXOzs7OztJQUF4QjtRQUF5QixjQUFpQjthQUFqQixVQUFpQixFQUFqQixxQkFBaUIsRUFBakIsSUFBaUI7WUFBakIseUJBQWlCOzs7Ozs7O3dCQUN4QyxJQUFJLENBQUMsSUFBSTs0QkFBRSxzQkFBTzt3QkFDbEIscUJBQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRzs7Ozs0QkFBQyxVQUFPLEdBQUc7Ozs7Z0RBQ3BCLHFCQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQUE7OzRDQUFyQyxNQUFNLEdBQUcsU0FBNEI7NENBQzNDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFBOzRDQUM5QixzQkFBTTs7O2lDQUNQLEVBQUMsQ0FBQyxFQUFBOzt3QkFKSCxTQUlHLENBQUE7Ozs7O0tBQ0o7SUFFRDs7O09BR0c7Ozs7Ozs7SUFDSyxrQ0FBUzs7Ozs7O0lBQWpCLFVBQWtCLEdBQVc7UUFDM0IsSUFBSSxDQUFDLEdBQUc7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUNwQixPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsaUJB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LENBQUMsUUFBUSxDQUFDLFNBQVM7Ozs7UUFBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxNQUFNLElBQUksTUFBTSxFQUFyQixDQUFxQixFQUFDO1FBQ3JFLElBQUcsTUFBTSxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQ2YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE1BQU0sUUFBQSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQztTQUN4RDthQUFLO1lBQ0osSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLFFBQUEsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztTQUNwRDtJQUNILENBQUM7O2dCQTNGRixVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dCQVZRLFVBQVU7Ozt5QkFEbkI7Q0FxR0MsQUE1RkQsSUE0RkM7U0F6RlksY0FBYzs7Ozs7O0lBR3pCLGtDQUE2RDs7Ozs7SUFHM0QsOEJBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBTaEh0dHBDbGllbnRDb25zdCwgUmVzcG9uc2UgfSBmcm9tICcuLi9jb25zdFNoSHR0cENsaWVudCc7XHJcbmltcG9ydCB7IFNoSHR0cENsaWVudFNlcnZpY2UgfSBmcm9tICcuL3NoLWh0dHAtY2xpZW50LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBcGlSZXNwb25zZUJvZHkgfSBmcm9tICcuLi91dGlsaXRpZXMvQXBpUmVzcG9uc2VCb2R5JztcclxuaW1wb3J0IHsgYXN5bmMgfSBmcm9tICdAYW5ndWxhci9jb3JlL3Rlc3RpbmcnO1xyXG5pbXBvcnQgeyBBcGlSZXNwb25zZSB9IGZyb20gJy4uL3V0aWxpdGllcy9BcGlSZXNwb25zZSc7XHJcblxyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgVmVyc2lvblNlcnZpY2Uge1xyXG5cclxuICAvL3ZlcnNpb27jga7jgq3jg6Pjg4Pjgrfjg6VcclxuICBwcml2YXRlIHZlcnNpb25zOiB7IGtleVVybDogc3RyaW5nLCB2ZXJzaW9uOiBzdHJpbmcgfVtdID0gW107XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50XHJcbiAgKSB7IH1cclxuXHJcbiAgLyoqXHJcbiAgICogdmVyc2lvbuOBruWIneacn+WMllxyXG4gICAqL1xyXG4gIHB1YmxpYyBhc3luYyBpbml0VmVyc2lvbiguLi51cmxzOiBzdHJpbmdbXSkge1xyXG4gICAgaWYgKCF1cmxzKSByZXR1cm47XHJcbiAgICBhd2FpdCBQcm9taXNlLmFsbCh1cmxzLm1hcChhc3luYyAodXJsKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZmV0Y2hWZXJzaW9uKHVybClcclxuICAgICAgdGhpcy5zZXRWZXJzaW9uTm8odXJsLCByZXN1bHQpXHJcbiAgICAgIHJldHVyblxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiB1cmzjgYvjgonjgq3jg7zjgpLnlJ/miJBcclxuICAgKiBAcGFyYW0gdXJsIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0S2V5VXJsKHVybDogc3RyaW5nKSB7XHJcbiAgICBpZiAoIXVybCkgcmV0dXJuIFwiXCI7XHJcbiAgICByZXR1cm4gdXJsLnNwbGl0KFNoSHR0cENsaWVudENvbnN0LkFQSV9VUkwpWzBdICsgU2hIdHRwQ2xpZW50Q29uc3QuVkVSU0lPTl9BUElfVVJMO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDjg5Djg4Pjgq/jgqjjg7Pjg4njga52ZXJzaW9u5oOF5aCx44KS5Y+W5b6XXHJcbiAgICovXHJcbiAgcHVibGljIGFzeW5jIGZldGNoVmVyc2lvbih1cmw6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBzID0gdGhpcy5zcGxpdEJ5QXBpVXJsKHVybCk7XHJcbiAgICBjb25zdCB0b2tlbiA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oYCR7U2hIdHRwQ2xpZW50Q29uc3QuQVVUSE9SSVpBVElPTl9UT0tFTn1gKVxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8QXBpUmVzcG9uc2VCb2R5PGFueT4+KHMsIHsgb2JzZXJ2ZTogUmVzcG9uc2UsIGhlYWRlcnM6IHsgXCJBdXRob3JpemF0aW9uXCI6IHRva2VuID8gU2hIdHRwQ2xpZW50Q29uc3QuQmVhcmVyICsgdG9rZW4gOiBTaEh0dHBDbGllbnRDb25zdC5CZWFyZXIgfSB9KS50b1Byb21pc2UoKVxyXG4gICAgICAudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLmJvZHkucmVkaXJlY3RVUkwgPT0gU2hIdHRwQ2xpZW50Q29uc3QuUkVMT0FEKSB7XHJcbiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7bG9jYXRpb24ucmVsb2FkKCk7fSwgMTAwKTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKChyZXNwb25zZS5ib2R5LnJlZGlyZWN0VVJMIHx8IFwiXCIpLmluZGV4T2YoU2hIdHRwQ2xpZW50Q29uc3QuSFRUUCkgIT0gLTEpIHtcclxuICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtsb2NhdGlvbi5ocmVmID0gcmVzcG9uc2UuYm9keS5yZWRpcmVjdFVSTDt9LCAxMDApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzcG9uc2UuYm9keS5hcHBsaWNhdGlvbkRhdGEgPyByZXNwb25zZS5ib2R5LmFwcGxpY2F0aW9uRGF0YS52ZXJzaW9uTm8gOiBcIlwiO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHVybOOCknNwbGl044GX44Gf5YCk44KS6L+U44GZXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzcGxpdEJ5QXBpVXJsKHVybDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdXJsLnNwbGl0KFNoSHR0cENsaWVudENvbnN0LkFQSV9VUkwpWzBdICsgU2hIdHRwQ2xpZW50Q29uc3QuVkVSU0lPTl9BUElfVVJMIHx8ICcnO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDjgq3jg6Pjg4Pjgrfjg6XjgZfjgabjgYTjgot2ZXJzaW9u44KSVVJM44GL44KJ5Y+W5b6X44GZ44KLXHJcbiAgICogQHBhcmFtIHVybFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhc3luYyBnZXRWZXJzaW9uKHVybDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIGNvbnN0IGtleVVybCA9IHRoaXMuZ2V0S2V5VXJsKHVybClcclxuICAgIGNvbnN0IHByb2plY3RWZXJzaW9uID0gdGhpcy52ZXJzaW9uc1xyXG4gICAgICAuZmluZCh2YWx1ZSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlLmtleVVybCA9PT0ga2V5VXJsXHJcbiAgICAgIH0pXHJcbiAgICBpZiAoIXByb2plY3RWZXJzaW9uKSB7XHJcbiAgICAgIGNvbnN0IHZlcnNpb24gPSBhd2FpdCB0aGlzLmZldGNoVmVyc2lvbih1cmwpXHJcbiAgICAgIC8vIC8v44Kt44Oj44OD44K344Ol44GZ44KLXHJcbiAgICAgIHRoaXMuc2V0VmVyc2lvbk5vKHVybCwgdmVyc2lvbilcclxuICAgICAgcmV0dXJuIHZlcnNpb247XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcHJvamVjdFZlcnNpb24udmVyc2lvbjtcclxuXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5fjgZHlj5bjgaPjgZ92ZXJzaW9uTm/jgpLjgq3jg6Pjg4Pjgrfjg6XjgZnjgotcclxuICAgKiBAcGFyYW0gdXJsIGFwaVVybFxyXG4gICAqIEBwYXJhbSB2ZXJzaW9uTm8g44OQ44OD44Kv44Ko44Oz44OJ44GudmVyc2lvbiBcclxuICAgKi9cclxuICBwdWJsaWMgc2V0VmVyc2lvbk5vKHVybDogc3RyaW5nLCB2ZXJzaW9uTm86IHN0cmluZykge1xyXG4gICAgY29uc3Qga2V5VXJsID0gdGhpcy5nZXRLZXlVcmwodXJsKTtcclxuICAgIGlmICgha2V5VXJsIHx8ICF2ZXJzaW9uTm8pIHJldHVyblxyXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy52ZXJzaW9ucy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtLmtleVVybCA9PSBrZXlVcmwpO1xyXG4gICAgaWYocmVzdWx0ICE9IC0xKSB7XHJcbiAgICAgIHRoaXMudmVyc2lvbnNbcmVzdWx0XSA9IHsga2V5VXJsLCB2ZXJzaW9uOiB2ZXJzaW9uTm8gfTtcclxuICAgIH1lbHNlIHtcclxuICAgICAgdGhpcy52ZXJzaW9ucy5wdXNoKHsga2V5VXJsLCB2ZXJzaW9uOiB2ZXJzaW9uTm8gfSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==